<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pencarian Aset</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --card-bg: rgba(255,255,255,0.9); }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: url('https://upload.wikimedia.org/wikipedia/commons/f/f8/KRL_Commuterline_Jabodetabek.jpg') no-repeat center center fixed;
    background-size: cover;
  }
  .overlay {
    min-height: 100vh;
    padding: 16px;
    background: linear-gradient(to bottom, rgba(255,255,255,0.92), rgba(255,255,255,0.92));
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
  }
  .search-box {
    display: flex;
    gap: 8px;
    position: relative;
    margin-bottom: 16px;
  }
  .search-input {
    flex: 1;
    font-size: 16px;
    padding: 12px 14px;
    border: 1px solid #d0d7de;
    border-radius: 10px;
  }
  .search-btn {
    padding: 12px 16px;
    border: 1px solid #d0d7de;
    background: white;
    border-radius: 10px;
    cursor: pointer;
  }
  .search-btn:active { transform: scale(0.99); }
  .autocomplete-items {
    position: absolute;
    top: 48px;
    left: 0;
    right: 52px;
    border: 1px solid #d0d7de;
    border-top: none;
    background: white;
    border-radius: 0 0 10px 10px;
    max-height: 220px;
    overflow-y: auto;
    z-index: 10;
  }
  .autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
  }
  .autocomplete-item:hover { background: #f6f8fa; }
  .card {
    background: var(--card-bg);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  }
  .result-table { margin-top: 4px; }
  .row { display: flex; align-items: flex-start; padding: 4px 0; }
  .label { min-width: 160px; font-weight: 600; }
  .colon { width: 16px; text-align: center; }
  .value { flex: 1; }
  .keterangan { margin-top: 8px; white-space: pre-wrap; }
  @media (max-width: 600px) {
    .label { min-width: 130px; }
    .search-btn { padding: 12px; }
    .autocomplete-items { right: 0; }
  }
</style>
</head>
<body>
  <div class="overlay">
    <div class="container">
      <div class="search-box">
        <input class="search-input" id="kodeInput" placeholder="Masukkan kode aset, contoh: 10600029 atau 10600029-0" autocomplete="off">
        <button class="search-btn" id="btnSearch" title="Cari">üîç</button>
        <div id="autocomplete-list" class="autocomplete-items" style="display:none;"></div>
      </div>
      <div id="result" class="card"></div>
    </div>
  </div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTafvAiaKbaQt2RIboLf9nY6v8mltXLhSN4R-l-LZGFmic1p0-83knr-g-bFEoPDB8Rl2T661YdYFTj/pub?gid=1753334008&single=true&output=csv";
let assets = [];

// Util
const isEightDigits = (v) => /^\\d{8}$/.test(v || "");
const toQueryKode = (v) => isEightDigits(v) ? (v + "-0") : v;
const sanitize = (s) => (s ?? "").toString().trim();

function buildAssetsFromRows(rows) {
  // Cari baris header yang kolom E berisi kata 'Kode' dan 'Aset'
  let headerIdx = 0;
  for (let i = 0; i < Math.min(10, rows.length); i++) {
    const cell = (rows[i][4] || "").toLowerCase();
    if (cell.includes("kode") && cell.includes("aset")) { headerIdx = i; break; }
  }
  const dataRows = rows.slice(headerIdx + 1);
  const mapped = dataRows.map(r => ({
    kode: sanitize(r[4]),                 // E: Kode Aset
    deskripsi: sanitize(r[5]),            // F: Deskripsi
    kapitalisasi: sanitize(r[6]),         // G: Kapitalisasi
    nilai: sanitize(r[7]),                // H: Nilai Perolehan
    j: sanitize(r[9]),                    // J (fallback untuk opname jika K kosong)
    k: sanitize(r[10]),                   // K: Opname Terakhir
    lokasi: sanitize(r[13]),              // N: Lokasi
    detail: sanitize(r[14]),              // O: Detail Lokasi
    keterangan: sanitize(r[15])           // P: Keterangan
  })).filter(a => a.kode);
  // Gabungkan opname K atau fallback J
  return mapped.map(a => ({
    ...a,
    opname: a.k || a.j
  }));
}

function loadCSV() {
  fetch(csvUrl)
    .then(res => res.text())
    .then(text => {
      const parsed = Papa.parse(text, { header: false, skipEmptyLines: true });
      assets = buildAssetsFromRows(parsed.data);
    })
    .catch(err => {
      document.getElementById('result').innerHTML =
        '<div style=\"color:#b91c1c\">Gagal memuat data CSV. Periksa koneksi atau izin publik Sheet.</div>';
      console.error(err);
    });
}

// Autocomplete
const input = document.getElementById('kodeInput');
const list = document.getElementById('autocomplete-list');
function renderAutocomplete(matches) {
  if (!matches.length) { list.style.display = 'none'; list.innerHTML = ''; return; }
  list.innerHTML = '';
  matches.forEach(m => {
    const div = document.createElement('div');
    div.className = 'autocomplete-item';
    div.textContent = m.kode;
    div.onclick = () => {
      input.value = m.kode;
      list.style.display = 'none';
      list.innerHTML = '';
      searchAsset();
    };
    list.appendChild(div);
  });
  list.style.display = 'block';
}

input.addEventListener('input', function() {
  const raw = this.value.trim();
  const val = raw;
  if (val.length >= 8) {
    let needle = val;
    // Saat tepat 8 digit, juga tampilkan kandidat dengan tambahan -0
    const needleAlt = isEightDigits(val) ? (val + "-0") : null;
    const matches = assets.filter(a => {
      if (!a.kode) return false;
      if (a.kode.startsWith(val)) return true;
      if (needleAlt && a.kode.startsWith(needleAlt)) return true;
      return false;
    }).slice(0, 12);
    // Jika tepat 8 digit & belum ada kode persis val-0 di daftar, sisipkan sebagai item pertama
    if (needleAlt && !matches.find(x => x.kode === needleAlt)) {
      const alt = assets.find(a => a.kode === needleAlt);
      if (alt) matches.unshift(alt);
    }
    renderAutocomplete(matches);
  } else {
    list.style.display = 'none';
    list.innerHTML = '';
  }
});

// Enter untuk cari
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchAsset();
  }
});
document.getElementById('btnSearch').addEventListener('click', searchAsset);

// Render hasil
function createRow(label, value) {
  if (!value) return '';
  return `<div class="row"><div class="label">${label}</div><div class="colon">:</div><div class="value">${value}</div></div>`;
}
function showNotFound(q) {
  document.getElementById('result').innerHTML =
    `<div>Tidak ditemukan untuk <b>${q}</b>. Coba ketik minimal 8 digit untuk melihat saran.</div>`;
}
function searchAsset() {
  const raw = input.value.trim();
  const q = toQueryKode(raw);
  // Cari kode persis q; jika tidak ada dan raw bukan 8 digit, coba yang startsWith
  let asset = assets.find(a => a.kode === q);
  if (!asset && !isEightDigits(raw)) {
    asset = assets.find(a => a.kode && a.kode.startsWith(raw));
  }
  if (!asset) { showNotFound(q); return; }

  const html =
    createRow("Kode Aset", asset.kode) +
    createRow("Deskripsi", asset.deskripsi) +
    createRow("Kapitalisasi", asset.kapitalisasi) +
    createRow("Nilai Perolehan", asset.nilai) +
    createRow("Lokasi", asset.lokasi) +
    createRow("Detail Lokasi", asset.detail) +
    createRow("Opname Terakhir", asset.opname) +
    (asset.keterangan ? `<div class="keterangan">${asset.keterangan}</div>` : '');
  document.getElementById('result').innerHTML = `<div class="result-table">${html}</div>`;
}

// Start
loadCSV();
</script>
</body>
</html>
